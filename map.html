<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Map</title>
    <meta name="author" content="Louiza Agroti,Mariana Mina" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="baseline_location_on_black_18dp.png" type="image/x-icon" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
        crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="map_style.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
</head>

<body>
    <div id="mapid"></div>
    <div class="modal fade" id="modalReadForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">PV System</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">
                    <div>
                        <label for="ID">ID</label>
                        <input type="text" id="ID" class="form-control validate" readonly>
                    </div>
                    <div>
                        <label for="Name">Name</label>
                        <input type="text" id="Name" class="form-control validate">
                    </div>
                    <div>
                        <label for="Address">Address</label>
                        <input type="text" id="Address" class="form-control validate">
                    </div>
                    <div>
                        <label for="latlng">Coordinates</label>
                        <input type="text" id="latlng" class="form-control validate">
                    </div>
                    <div>
                        <label for="Operator">Operator</label>
                        <input type="text" id="Operator" class="form-control validate">
                    </div>
                    <div>
                        <label for="CommissionDate">CommissionDate</label>
                        <input type="text" id="CommissionDate" class="form-control validate">
                    </div>
                    <div>
                        <label for="Description">Description</label>
                        <input type="text" id="Description" class="form-control validate">
                    </div>
                    <div>
                        <label for="SystemPower">SystemPower</label>
                        <input type="text" id="SystemPower" class="form-control validate">
                    </div>
                    <div>
                        <label for="AnnualProduction">AnnualProduction</label>
                        <input type="text" id="AnnualProduction" class="form-control validate">
                    </div>
                    <div>
                        <label for="CO2Avoided">CO2Avoided</label>
                        <input type="text" id="CO2Avoided" class="form-control validate">
                    </div>
                    <div>
                        <label for="Reimbursement">Reimbursement</label>
                        <input type="text" id="Reimbursement" class="form-control validate">
                    </div>
                    <div>
                        <label for="SolarPanelModules">SolarPanelModules</label>
                        <input type="text" id="SolarPanelModules" class="form-control validate">
                    </div>
                    <div>
                        <label for="AzimuthAngle">AzimuthAngle</label>
                        <input type="text" id="AzimuthAngle" class="form-control validate">
                    </div>
                    <div>
                        <label for="InclinationAngle">InclinationAngle</label>
                        <input type="text" id="InclinationAngle" class="form-control validate">
                    </div>
                    <div>
                        <label for="Communication">Communication</label>
                        <input type="text" id="Communication" class="form-control validate">
                    </div>
                    <div>
                        <label for="Inverter">Inverter</label>
                        <input type="text" id="Inverter" class="form-control validate">
                    </div>
                    <div>
                        <label for="Sensors">Sensors</label>
                        <input type="text" id="Sensors" class="form-control validate">
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-default" id="update_PV_System">Update PV System</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalAddForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Add PV System</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">
                    <div>
                        <label for="Name">Name</label>
                        <input type="text" id="Name" class="form-control validate">
                    </div>
                    <div>
                        <label for="Address">Address</label>
                        <input type="text" id="Address" class="form-control validate">
                    </div>
                    <div>
                        <label for="latlng">Coordinates</label>
                        <input type="text" id="latlng" class="form-control validate">
                    </div>
                    <div>
                        <label for="Operator">Operator</label>
                        <input type="text" id="Operator" class="form-control validate">
                    </div>
                    <div>
                        <label for="CommissionDate">CommissionDate</label>
                        <input type="text" id="CommissionDate" class="form-control validate">
                    </div>
                    <div>
                        <label for="Description">Description</label>
                        <input type="text" id="Description" class="form-control validate">
                    </div>
                    <div>
                        <label for="SystemPower">SystemPower</label>
                        <input type="text" id="SystemPower" class="form-control validate">
                    </div>
                    <div>
                        <label for="AnnualProduction">AnnualProduction</label>
                        <input type="text" id="AnnualProduction" class="form-control validate">
                    </div>
                    <div>
                        <label for="CO2Avoided">CO2Avoided</label>
                        <input type="text" id="CO2Avoided" class="form-control validate">
                    </div>
                    <div>
                        <label for="Reimbursement">Reimbursement</label>
                        <input type="text" id="Reimbursement" class="form-control validate">
                    </div>
                    <div>
                        <label for="SolarPanelModules">SolarPanelModules</label>
                        <input type="text" id="SolarPanelModules" class="form-control validate">
                    </div>
                    <div>
                        <label for="AzimuthAngle">AzimuthAngle</label>
                        <input type="text" id="AzimuthAngle" class="form-control validate">
                    </div>
                    <div>
                        <label for="InclinationAngle">InclinationAngle</label>
                        <input type="text" id="InclinationAngle" class="form-control validate">
                    </div>
                    <div>
                        <label for="Communication">Communication</label>
                        <input type="text" id="Communication" class="form-control validate">
                    </div>
                    <div>
                        <label for="Inverter">Inverter</label>
                        <input type="text" id="Inverter" class="form-control validate">
                    </div>
                    <div>
                        <label for="Sensors">Sensors</label>
                        <input type="text" id="Sensors" class="form-control validate">
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button class="btn btn-default" id="add_PV_System">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Delete PV System</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">
                    <div>
                        <label for="Name">ID</label>
                        <input type="text" id="ID" class="form-control validate">
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-default" id="delete_PV_System">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <nav class="navbar fixed-bottom navbar-expand-sm bg-dark navbar-dark">
            <form class="navbar-form pull-right">
                <span style="padding-right: 20px;"><a class='btn btn-primary btn-small' data-toggle="modal" href="#modalAddForm"><i
                            class="icon-plus-sign icon-white"></i> Add PV System to the map</a></span>
                <span><a class='btn btn-danger btn-small' data-toggle="modal" href="#modalDelete"><i class="icon-minus-sign icon-white"></i>
                        Remove PV System from the map</a></span>
            </form>
        </nav>
    </footer>
    <script>
        var mymap = L.map('mapid').setView([51.505, -0.09], 13);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFyaWFuYW1pbmEiLCJhIjoiY2pwNnF3czdlMG00MTN3cXN6MDZkM3FqdyJ9.Uu6_jNN8fQy28txKJ46-mA', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="http://mapbox.com">Mapbox</a>',
            id: 'mapbox.streets'
        }).addTo(mymap);

        $.ajax({
            type: "GET",
            url: "read.php",
            dataType: "json",
            success: function (response) {
                console.log(response);
                L.geoJson(response).addTo(mymap).on('click', function (e) {
                    // Force close the popup.
                    e.layer.closePopup();

                    var feature = e.layer.feature;
                    var ID = feature.properties.ID;
                    var Name = feature.properties.Name;
                    var Photo = feature.properties.Photo;
                    var Address = feature.properties.Address;
                    var Operator = feature.properties.Operator;
                    var CommissionDate = feature.properties.CommissionDate;
                    var Description = feature.properties.Description;
                    var SystemPower = feature.properties.SystemPower;
                    var AnnualProduction = feature.properties.AnnualProduction;
                    var CO2Avoided = feature.properties.CO2Avoided;
                    var Reimbursement = feature.properties.Reimbursement;
                    var SolarPanelModules = feature.properties.SolarPanelModules;
                    var AzimuthAngle = feature.properties.AzimuthAngle;
                    var InclinationAngle = feature.properties.InclinationAngle;
                    var Communication = feature.properties.Communication;
                    var Inverter = feature.properties.Inverter;
                    var Sensors = feature.properties.Sensors;
                    var latlng = feature.geometry.coordinates;

                    // Modal Content
                    $("#ID").val(ID);
                    $("#Name").val(Name);
                    $("#Photo").val(Photo);
                    $("#Address").val(Address);
                    $("#Operator").val(Operator);
                    $("#CommissionDate").val(CommissionDate);
                    $("#Description").val(Description);
                    $("#SystemPower").val(SystemPower);
                    $("#AnnualProduction").val(AnnualProduction);
                    $("#CO2Avoided").val(CO2Avoided);
                    $("#Reimbursement").val(Reimbursement);
                    $("#SolarPanelModules").val(SolarPanelModules);
                    $("#AzimuthAngle").val(AzimuthAngle);
                    $("#InclinationAngle").val(InclinationAngle);
                    $("#Communication").val(Communication);
                    $("#Inverter").val(Inverter);
                    $("#Sensors").val(Sensors);
                    $("#latlng").val(formatLatLng(latlng));
                    $('#modalReadForm').modal('show');
                });
            }, error: function (response) {
                
            }
        });
        // Clear Modal Data
        function empty() {
            // TODO: Clear Modal when Modal is closed for next marker clicked
        }

        // Formats Latitude and Longitude for Modal
        function formatLatLng(latlng) {
            // TODO: Format Latitude and Longitude
            return latlng;
        }

        $('#delete_PV_System').click(function () {
            var tmpID = $("#modalDelete #ID").val();
            var inputID = 'ID=' + tmpID;
            //function to turn url to an object
            function getUrlVars(inputID) {
                var hash;
                var myJson = {};
                var hashes = inputID.split('&');
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    myJson[hash[0]] = hash[1];
                }
                return JSON.stringify(myJson);
            }

            //pass serialized data to function
            var test = getUrlVars(inputID);
            $.ajax({
                type: "DELETE",
                url: "delete.php",
                data: test,
                ContentType: "application/json",
                success: function (response) {
                    alert('Successfully deleted');
                }, error: function (response) {
                    alert('Could not be deleted');
                }
            });
        });

        $('#add_PV_System').click(function () {
            var Name = $("#modalAddForm #Name").val();
            var Photo = $("#modalAddForm #Photo").val();
            var Address = $("#modalAddForm #Address").val();
            var Operator = $("#modalAddForm #Operator").val();
            var CommissionDate = $("#modalAddForm #CommissionDate").val();
            var Description = $("#modalAddForm #Description").val();
            var SystemPower = $("#modalAddForm #SystemPower").val();
            var AnnualProduction = $("#modalAddForm #AnnualProduction").val();
            var CO2Avoided = $("#modalAddForm #CO2Avoided").val();
            var Reimbursement = $("#modalAddForm #Reimbursement").val();
            var SolarPanelModules = $("#modalAddForm #SolarPanelModules").val();
            var AzimuthAngle = $("#modalAddForm #AzimuthAngle").val();
            var InclinationAngle = $("#modalAddForm #InclinationAngle").val();
            var Communication = $("#modalAddForm #Communication").val();
            var Inverter = $("#modalAddForm #Inverter").val();
            var Sensors = $("#modalAddForm #Sensors").val();
            var latlng = $("#modalAddForm #latlng").val().split(",");
            var coordinate_X = latlng[0];
            var coordinate_Y = latlng[1];
            var dataString = 'Name=' + Name + '&Photo=' + Photo + '&Address=' + Address + '&Operator=' + Operator + '&CommissionDate=' + CommissionDate + '&Description=' + Description + '&SystemPower=' + SystemPower + '&AnnualProduction=' + AnnualProduction + '&CO2Avoided=' + CO2Avoided + '&Reimbursement=' + Reimbursement + '&SolarPanelModules=' + SolarPanelModules + '&AzimuthAngle=' + AzimuthAngle + '&InclinationAngle=' + InclinationAngle + '&Communication=' + Communication + '&Inverter=' + Inverter + '&Sensors=' + Sensors + '&Coordinate_X=' + coordinate_X + '&Coordinate_Y=' + coordinate_Y;
            //function to turn url to an object
            function getUrlVars(url) {
                var hash;
                var myJson = {};
                var hashes = url.split('&');
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    myJson[hash[0]] = hash[1];
                }
                return JSON.stringify(myJson);
            }

            //pass serialized data to function
            var test = getUrlVars(dataString);
            $.ajax({
                type: "POST",
                url: "create.php",
                data: test,
                ContentType: "application/json",
                success: function (response) {
                    alert('Successfully added');
                },
                error: function (response) {
                    alert('Could not be added');
                }
            });
        });

        $('#update_PV_System').click(function () {
            var ID = $("#modalReadForm #ID").val();
            var Name = $("#modalReadForm #Name").val();
            var Photo = $("#modalReadForm #Photo").val();
            var Address = $("#modalReadForm #Address").val();
            var Operator = $("#modalReadForm #Operator").val();
            var CommissionDate = $("#modalReadForm #CommissionDate").val();
            var Description = $("#modalReadForm #Description").val();
            var SystemPower = $("#modalReadForm #SystemPower").val();
            var AnnualProduction = $("#modalReadForm #AnnualProduction").val();
            var CO2Avoided = $("#modalReadForm #CO2Avoided").val();
            var Reimbursement = $("#modalReadForm #Reimbursement").val();
            var SolarPanelModules = $("#modalReadForm #SolarPanelModules").val();
            var AzimuthAngle = $("#modalReadForm #AzimuthAngle").val();
            var InclinationAngle = $("#modalReadForm #InclinationAngle").val();
            var Communication = $("#modalReadForm #Communication").val();
            var Inverter = $("#modalReadForm #Inverter").val();
            var Sensors = $("#modalReadForm #Sensors").val();
            var latlng = $("#modalReadForm #latlng").val().split(",");
            var coordinate_X = latlng[0];
            var coordinate_Y = latlng[1];
            var dataString = 'ID=' + ID + '&Name=' + Name + '&Photo=' + Photo + '&Address=' + Address + '&Operator=' + Operator + '&CommissionDate=' + CommissionDate + '&Description=' + Description + '&SystemPower=' + SystemPower + '&AnnualProduction=' + AnnualProduction + '&CO2Avoided=' + CO2Avoided + '&Reimbursement=' + Reimbursement + '&SolarPanelModules=' + SolarPanelModules + '&AzimuthAngle=' + AzimuthAngle + '&InclinationAngle=' + InclinationAngle + '&Communication=' + Communication + '&Inverter=' + Inverter + '&Sensors=' + Sensors + '&Coordinate_X=' + coordinate_X + '&Coordinate_Y=' + coordinate_Y;
            //function to turn url to an object
            function getUrlVars(url) {
                var hash;
                var myJson = {};
                var hashes = url.split('&');
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    myJson[hash[0]] = hash[1];
                }
                return JSON.stringify(myJson);
            }

            //pass serialized data to function
            var test = getUrlVars(dataString);
            $.ajax({
                type: "PUT",
                url: "update.php",
                data: test,
                ContentType: "application/json",
                success: function (response) {
                    alert('Successfully Updated');
                },
                error: function (response) {
                    alert('Could not be Updated');
                }
            });
        });
    </script>
</body>

</html>